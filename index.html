<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fredagsdrinken</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{ --bg:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#f59e0b; --chip:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35); --r:14px }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); line-height:1.45;
      background-image:
        radial-gradient(rgba(255,255,255,.04) 1px, transparent 1px),
        radial-gradient(1000px 800px at 15% -10%, rgba(245,158,11,.25) 0%, transparent 60%),
        radial-gradient(900px 700px at 110% 0%, rgba(34,197,94,.25) 0%, transparent 60%),
        radial-gradient(800px 700px at 50% 120%, rgba(59,130,246,.18) 0%, transparent 60%),
        linear-gradient(180deg, #0b1222 0%, #0f172a 60%, #0b1222 100%);
      background-size:6px 6px,auto,auto,auto,auto; background-attachment:fixed,fixed,fixed,fixed,fixed; transition: background 400ms ease;}
    body.xmas{
      background-image: linear-gradient(180deg, #ffe6ea 0%, #ffd3dc 60%, #ffe6ea 100%);
      background-attachment: fixed;
    }
    body.xmas::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.16;
      --flake: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><g fill='none' stroke='white' stroke-width='6' stroke-linecap='round'><path d='M50 10v80'/><path d='M10 50h80'/><path d='M22 22l56 56'/><path d='M22 78l56-56'/></g></svg>");
      background-image: var(--flake), var(--flake);
      background-size: 120px 120px, 180px 180px;
      background-repeat: repeat, repeat;
      background-position: 0 0, 60px 40px;
    }
    @keyframes snow {
  0% { transform: translateY(-2%); }
  100% { transform: translateY(2%); }
}
@keyframes snowBig {
  0% { transform: translateY(-5%) translateX(0); }
  50% { transform: translateY(5%) translateX(-1%); }
  100% { transform: translateY(-5%) translateX(0); }
}
body.xmas::after{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.08;
  --flake2: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><g fill='none' stroke='white' stroke-width='4' stroke-linecap='round'><path d='M50 8v84'/><path d='M8 50h84'/><path d='M25 25l50 50'/><path d='M25 75l50-50'/></g></svg>");
  background-image: var(--flake2);
  background-size: 200px 200px;
  background-repeat: repeat;
  background-position: 30px 20px;
}
 0% { transform: translateY(-2%); } 100% { transform: translateY(2%); } }
    .wrap{max-width:1000px; margin:28px auto 80px; padding:0 18px; position:relative; z-index:1}
    header{display:flex; align-items:center; gap:14px; flex-wrap:wrap; margin-bottom:18px}
    .logo{width:52px; height:52px; border-radius:14px; display:grid; place-items:center;
      background: linear-gradient(135deg,#22c55e,#f59e0b); box-shadow:var(--shadow); font-weight:800; font-size:24px; color:white}
    body.xmas .logo{ background: linear-gradient(135deg,#dc2626,#16a34a); }
    h1{font-size: clamp(26px, 4vw, 38px); margin:0}
    .sub{color:var(--muted)}
    .panel{background:rgba(10,15,25,.55); backdrop-filter:saturate(140%) blur(10px); border:1px solid rgba(255,255,255,.06); border-radius:var(--r); box-shadow:var(--shadow); padding:18px}
    .controls{display:grid; gap:14px; grid-template-columns:1fr}
    @media (min-width:780px){ .controls{ grid-template-columns:1fr 1fr 1fr } }
    .segmented{display:inline-flex; background:var(--chip); border-radius:12px; padding:4px; gap:4px}
    .segmented button{border:0; padding:10px 14px; border-radius:10px; color:var(--text); background:transparent; cursor:pointer; font-weight:600}
    .segmented button.active{background:linear-gradient(135deg,#22c55e,#3b82f6); color:#03110a}
    body.xmas .segmented button.active{background:linear-gradient(135deg,#dc2626,#16a34a); color:#130606}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{border:1px solid rgba(255,255,255,.08); background:var(--chip); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:600; font-size:14px}
    .chip.active{ outline:2px solid rgba(34,197,94,.7) }
    body.xmas .chip.active{ outline:2px solid rgba(220,38,38,.7) }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}
    .button{appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:800; letter-spacing:.3px;
      background:linear-gradient(135deg,#22c55e,#3b82f6); color:#05140c; box-shadow:var(--shadow)}
    .button.secondary{ background:#0b1222; color:var(--text); border:1px solid rgba(255,255,255,.08) }
    .button.ghost{ background:transparent; border:1px dashed rgba(255,255,255,.18); color:var(--text)}
    .button.small{ padding:8px 10px; border-radius:10px; font-weight:700 }
    body.xmas .button{ background:linear-gradient(135deg,#dc2626,#16a34a); color:#130606 }
    .hint{ color:var(--muted); font-size:14px }
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr }
    @media (min-width: 860px){ .grid{ grid-template-columns: 1.1fr .9fr } }
    .card{ background:rgba(6,10,20,.75); border:1px solid rgba(255,255,255,.06); border-radius:var(--r); padding:18px; box-shadow:var(--shadow); min-height:260px }
    .title{font-size:24px; font-weight:800; margin:0}
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(34,197,94,.15); color:#c6f6d5; border:1px solid rgba(34,197,94,.35); font-weight:700; font-size:12px }
    .badge.red{ background:rgba(239,68,68,.12); color:#fecaca; border-color:rgba(239,68,68,.35) }
    .meta{ display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 6px }
    .meta .pill{ background:var(--chip); padding:6px 10px; border-radius:999px; color:#94a3b8; font-weight:700; font-size:12px; border:1px solid rgba(255,255,255,.08)}
    .ingredients li,.steps li{ margin:6px 0 }
    .section-title{ font-size:13px; letter-spacing:.2px; color:#94a3b8; text-transform:uppercase; margin:14px 0 6px }
    .footer-row{ display:flex; flex-wrap:wrap; gap:8px; margin-top:16px }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111827; color:#e5e7eb; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); display:none; z-index:9999 }
    .footnote{ color:#94a3b8; font-size:12px; text-align:center; margin:28px 0 18px; opacity:.9 }
    #servings{ font-size: 22px; padding: 14px 16px; height: 52px; border-radius: 12px; border: 1px solid rgba(255,255,255,.18); background: rgba(15,23,42,.6); color: var(--text); outline: none; width: 100%; }
    #servings::placeholder{ color: rgba(148,163,184,.8); }
    @media (max-width: 420px){ #servings{ font-size: 24px; height: 56px; } }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  
/* Better contrast on light Xmas background for header text */
body.xmas header h1,
body.xmas header .sub{
  color:#111827;
  text-shadow: 0 1px 3px rgba(255,255,255,0.6), 0 2px 8px rgba(0,0,0,0.15);
}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">FD</div>
      <div>
        <h1>Fredagsdrinken</h1>
        <div class="sub">Tryck p√• knappen ‚Äì f√• ett slumpat recept. Spara dina favoriter f√∂r n√§sta fredag üç∏</div>
      </div>
    </header>

    <div class="panel">
      <div class="controls">
        <div>
          <div class="section-title">Typ av drink</div>
          <div class="segmented" role="tablist" aria-label="V√§lj drinktyp">
            <button class="active" id="btnAlcohol" role="tab" aria-selected="true">Med alkohol</button>
            <button id="btnNoAlcohol" role="tab" aria-selected="false">Alkoholfri</button>
          </div>
        </div>

        <div>
          <div class="section-title">Smakprofil (valfritt)</div>
          <div id="flavorChips" class="chips" aria-label="Filtrera p√• smak"></div>
          <div class="hint">V√§lj en eller flera profiler (t.ex. <b>frisk</b>, syrlig, s√∂t, bitter, kryddig, √∂rtig, <b>jul</b>).</div>
        </div>

        <div>
          <div class="section-title">Antal glas</div>
          <div class="row">
            <input id="servings" inputmode="numeric" pattern="[0-9]*" value="1" class="grow" aria-label="Antal glas" placeholder="1‚Äì12" />
            <button id="btnRandom" class="button">üé≤ Slumpa fram drink</button>
          </div>
          <div class="hint">Skriv ett heltal 1‚Äì12. M√§ngderna skalas automatiskt.</div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:18px">
      <div id="card" class="card" aria-live="polite">
        <p class="sub">Inga recept √§nnu. Tryck p√• <b>Slumpa fram drink</b> f√∂r att komma ig√•ng!</p>
      </div>

      <div class="card">
        <div class="section-title">Favoriter</div>
        <details id="favBox">
          <summary>Mina sparade drinkar</summary>
          <div id="favList" class="fav-list"></div>
        </details>

        <div class="section-title">Tips</div>
        <ul class="sub" style="margin-top:6px">
          <li>üìå Spara favoriter ‚Äì de ligger kvar i din webbl√§sare.</li>
          <li>üìã Kopiera eller dela receptet direkt till v√§nnerna.</li>
          <li>‚úèÔ∏è Anpassa m√§ngder via <em>Antal glas</em>.</li>
        </ul>
        <div class="section-title">Info</div>
        <p class="sub">Recepten √§r klassiker + egna varianter.</p>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status"></div>

<script>
let RECIPES = [];
let ALL_FLAVORS = [];
const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
const state = { type:"alcohol", flavors:new Set(), servings:1, currentId:null, favs:new Set(JSON.parse(localStorage.getItem("fredagsdrinken_favorites")||"[]")) };

// --- Xmas season: force jultema from "now" until 31 Dec every year ---
function isXmasSeason(){
  const now = new Date();
  const y = now.getFullYear();
  // start: 15 november 00:00, slut: 31 december 23:59:59
  const start = new Date(y, 10, 15, 0, 0, 0, 0);     // Nov = 10
  const end   = new Date(y, 11, 31, 23, 59, 59, 999); // Dec = 11
  return now >= start && now <= end;
}
(function scheduleMidnightThemeCheck(){
  function msToNextMidnight(){
    const now = new Date();
    const next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0,0,0,0);
    return next - now;
  }
  setTimeout(() => {
    updateTheme();           // k√∂r direkt vid midnatt
    scheduleMidnightThemeCheck(); // planera n√§sta
  }, msToNextMidnight());
})();
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) updateTheme(); // om appen √•terkommer i fokus
});



function toast(msg,ms=2000){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",ms); }
function getById(id){ return RECIPES.find(r=>r.id===id); }
function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function matchesFlavors(r,fl){ if(fl.size===0) return true; for(const f of fl) if(!r.flavors.includes(f)) return false; return true; }
function formatAmount(ing){
  if(typeof ing.amount_cl==="number"){
    const val=Math.round(ing.amount_cl*state.servings*2)/2;
    return `${val % 1 === 0 ? val.toFixed(0) : val} cl`;
  }
  return ing.amount || "";
}
function updateTheme(){
  const hasJul = state.flavors.has('jul') || (state.currentId && getById(state.currentId)?.flavors.includes('jul'));
  const forceSeason = isXmasSeason();
  document.body.classList.toggle('xmas', !!hasJul || forceSeason);
}
function setType(t){
  state.type=t;
  $("#btnAlcohol").classList.toggle("active",t==="alcohol");
  $("#btnNoAlcohol").classList.toggle("active",t==="noalcohol");
  $("#btnAlcohol").setAttribute("aria-selected", t==="alcohol" ? "true" : "false");
  $("#btnNoAlcohol").setAttribute("aria-selected", t==="noalcohol" ? "true" : "false");
  updateTheme();
}
function renderFavorites(){
  const box=$("#favList"); box.innerHTML="";
  if(state.favs.size===0){ box.innerHTML='<div class="sub">Inga favoriter sparade √§nnu.</div>'; return; }
  for(const id of state.favs){
    const r=getById(id); if(!r) continue;
    const div=document.createElement("div"); div.className="fav-item";
    div.innerHTML=`<div class="row" style="justify-content:space-between">
      <div><strong>${r.name}</strong><div class="sub">${r.type==="alcohol"?"Med alkohol":"Alkoholfri"} ‚Ä¢ ${r.flavors.map(f=>f[0].toUpperCase()+f.slice(1)).join(", ")}</div></div>
      <div class="row"><button class="button small secondary" data-open="${r.id}">√ñppna</button><button class="button small ghost" data-remove="${r.id}">Ta bort</button></div>
    </div>`;
    box.appendChild(div);
  }
  $$("#favList [data-open]").forEach(b=>b.addEventListener("click",e=>{ const id=e.currentTarget.getAttribute("data-open"); state.currentId=id; renderRecipe(getById(id)); $("#favBox").open=true; $("#card").scrollIntoView({behavior:"smooth"});}));
  $$("#favList [data-remove]").forEach(b=>b.addEventListener("click",e=>toggleFav(e.currentTarget.getAttribute("data-remove"))));
}
function renderRecipe(r){
  const card=$("#card"); const isFav=state.favs.has(r.id);
  const typeBadge=r.type==="alcohol"?`<span class="badge">Med alkohol</span>`:`<span class="badge red">Alkoholfri</span>`;
  const flavorPills=r.flavors.map(f=>`<span class="pill">${f[0].toUpperCase()+f.slice(1)}</span>`).join("");
  const ingList=r.ingredients.map(ing=>`<li>${formatAmount(ing)} ${ing.name}</li>`).join("");
  const steps=r.steps.map(s=>`<li>${s}</li>`).join("");
  card.innerHTML=`
    <div class="row" style="justify-content:space-between; align-items:flex-start; gap:10px">
      <div>
        <h2 class="title">${r.name}</h2>
        <div class="meta">${typeBadge}<span class="pill">${r.glass}</span><span class="pill">${r.ice}</span>${flavorPills}</div>
      </div>
      <div class="row">
        <button class="button small secondary" id="btnCopy">Kopiera</button>
        <button class="button small secondary" id="btnShare">Dela</button>
        <button class="button small ${isFav?'':'ghost'}" id="btnFav">${isFav?"‚òÖ Favorit":"‚òÜ Spara"}</button>
      </div>
    </div>
    <div class="section-title">Ingredienser f√∂r ${state.servings} glas</div>
    <ul class="ingredients">${ingList}</ul>
    <div class="section-title">G√∂r s√• h√§r</div>
    <ol class="steps">${steps}</ol>
    ${r.garnish?`<div class="section-title">Garnering</div><div>${r.garnish}</div>`:""}
    ${r.tips?`<div class="section-title">Tips</div><div class="sub">${r.tips}</div>`:""}
    <div class="footer-row"><button class="button" id="btnReroll">üé≤ Byt till en annan</button><button class="button ghost" id="btnReset">Rensa filter</button></div>
  `;
  $("#btnReroll").addEventListener("click", randomize);
  $("#btnReset").addEventListener("click", ()=>{ state.flavors.clear(); $$("#flavorChips .chip").forEach(c=>c.classList.remove("active")); toast("Filter √•terst√§llda"); updateTheme(); });
  $("#btnFav").addEventListener("click", ()=>toggleFav(r.id));
  $("#btnCopy").addEventListener("click", ()=>copyRecipe(r));
  $("#btnShare").addEventListener("click", ()=>shareRecipe(r));
  updateTheme();
}
function recipeToText(r){
  const lines=[];
  lines.push(`üçπ ${r.name} ‚Äî ${r.type==="alcohol"?"Med alkohol":"Alkoholfri"}`);
  lines.push(`Glas: ${r.glass} ‚Ä¢ Is: ${r.ice}`);
  lines.push(`Smak: ${r.flavors.join(", ")}`); lines.push("");
  lines.push(`Ingredienser (${state.servings} glas):`);
  r.ingredients.forEach(ing=>{ const amt=formatAmount(ing); lines.push(`‚Ä¢ ${amt?amt+' ':''}${ing.name}`); });
  lines.push(""); lines.push("G√∂r s√• h√§r:"); r.steps.forEach((s,i)=>lines.push(`${i+1}. ${s}`));
  if(r.garnish){ lines.push(""); lines.push("Garnering: "+r.garnish); }
  if(r.tips){ lines.push(""); lines.push("Tips: "+r.tips); }
  lines.push(""); lines.push("‚Äî Skapad i Fredagsdrinken"); return lines.join("\n");
}
function toggleFav(id){
  if(state.favs.has(id)){ state.favs.delete(id); toast("Tog bort fr√•n favoriter"); }
  else{ state.favs.add(id); toast("Sparad som favorit ‚≠ê"); }
  localStorage.setItem("fredagsdrinken_favorites", JSON.stringify(Array.from(state.favs)));
  renderFavorites();
  if(state.currentId===id) renderRecipe(getById(id));
}
function randomize(){
  const pool=RECIPES.filter(r=>r.type===state.type && matchesFlavors(r, state.flavors));
  let list=pool; if(pool.length===0){ list=RECIPES.filter(r=>r.type===state.type); toast("Inga tr√§ffar p√• vald smakprofil ‚Äì visar n√•got annat gott √§nd√• ‚ú®"); }
  const r=pickRandom(list); state.currentId=r.id; renderRecipe(r);
  $("#card").scrollIntoView({behavior:"smooth", block:"start"});
}
function copyRecipe(r){
  const text=recipeToText(r);
  navigator.clipboard?.writeText(text).then(()=>toast("Receptet kopierat üìã")).catch(()=>toast("Kunde inte kopiera ‚Äì markera texten manuellt."));
}
function shareRecipe(r){
  const text=recipeToText(r);
  if(navigator.share){ navigator.share({ title:r.name, text }).then(()=>toast("Delat! üéâ")).catch(()=>{}); }
  else{ copyRecipe(r); }
}
async function loadRecipes(){
  const res = await fetch('recipes.json', {cache:'no-store'});
  if(!res.ok){ throw new Error('Kunde inte l√§sa recipes.json'); }
  RECIPES = await res.json();
  RECIPES.forEach(r => { r.flavors = r.flavors.map(f => f === 'fr√§sch' ? 'frisk' : f); });
  ALL_FLAVORS = Array.from(new Set(RECIPES.flatMap(r=>r.flavors))).sort();
  const fc=$("#flavorChips"); fc.innerHTML='';
  ALL_FLAVORS.forEach(f=>{
    const b=document.createElement("button");
    b.className="chip"; b.textContent=f[0].toUpperCase()+f.slice(1); b.dataset.flavor=f;
    b.addEventListener("click",()=>{
      if(state.flavors.has(f)){ state.flavors.delete(f); b.classList.remove("active"); }
      else { state.flavors.add(f); b.classList.add("active"); }
      updateTheme();
    });
    fc.appendChild(b);
  });
}
function init(){
  $("#btnAlcohol").addEventListener("click",()=>setType("alcohol"));
  $("#btnNoAlcohol").addEventListener("click",()=>setType("noalcohol"));
  const s = $("#servings");
  s.addEventListener("keydown", e => { if (["e","E","+","-",".",","].includes(e.key)) e.preventDefault(); });
  s.addEventListener("wheel", e => e.preventDefault(), {passive:false});
  s.addEventListener("input", e => {
    const raw = e.target.value.replace(/\D+/g,'');
    if (raw === "") { state.servings = null; return; }
    let v = parseInt(raw, 10);
    if (Number.isNaN(v)) { state.servings = null; return; }
    state.servings = v;
    if(state.currentId) renderRecipe(getById(state.currentId));
  });
  s.addEventListener("blur", () => {
    let raw = s.value.replace(/\D+/g,'');
    let v = parseInt(raw || "1", 10);
    if (!v || v < 1) v = 1;
    if (v > 12) v = 12;
    s.value = String(v);
    state.servings = v;
    if(state.currentId) renderRecipe(getById(state.currentId));
  });
  function ensureServings(){
    let raw = s.value.replace(/\D+/g,'');
    let v = parseInt(raw || "1", 10);
    if (!v || v < 1) v = 1;
    if (v > 12) v = 12;
    s.value = String(v);
    state.servings = v;
  }
  $("#btnRandom").addEventListener("click", () => { ensureServings(); randomize(); });
  renderFavorites();
  updateTheme();
}
document.addEventListener("DOMContentLoaded", async () => { try { await loadRecipes(); } catch(e){ console.error(e); toast("Kunde inte ladda recept. Kontrollera recipes.json"); } init(); });
if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(console.error)); }
</script>
<footer class="footnote">Skapad av JL</footer>
</body>
</html>
